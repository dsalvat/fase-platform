// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Roles de usuario: USER, SUPERVISOR, ADMIN, SUPERADMIN
enum UserRole {
  USER
  SUPERVISOR
  ADMIN
  SUPERADMIN
}

// Estados de usuario: INVITED, ACTIVE, DEACTIVATED
enum UserStatus {
  INVITED      // Usuario invitado, pendiente de primer login
  ACTIVE       // Usuario activo
  DEACTIVATED  // Usuario desactivado por el administrador
}

// Idiomas disponibles
enum Language {
  ES  // Castellano
  CA  // Catalan
  EN  // English
}

// Estados de Big Rock (progresión única)
enum BigRockStatus {
  CREADO              // Estado inicial al crear el Big Rock
  CONFIRMADO          // Usuario confirma el Big Rock
  FEEDBACK_RECIBIDO   // Supervisor ha dado feedback
  EN_PROGRESO         // Trabajo en progreso
  FINALIZADO          // Completado
}

// Categorias FASE para Big Rocks (opcional)
enum FaseCategory {
  FOCUS
  ATENCION
  SISTEMAS
  ENERGIA
}

// Estados de TAR
enum TarStatus {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
}

// Tipos de actividad
enum ActivityType {
  SEMANAL
  DIARIA
}

// Tipos de medallas
enum MedalType {
  CONSTANCIA
  CLARIDAD
  EJECUCION
  MEJORA_CONTINUA
}

// Niveles de medallas
enum MedalLevel {
  BRONCE
  PLATA
  ORO
  DIAMANTE
}

// Tipos de entidad para Activity Log
enum LogEntityType {
  BIG_ROCK
  TAR
  ACTIVITY
  KEY_MEETING
}

// Tipos de accion para Activity Log
enum LogActionType {
  CREATE
  UPDATE
  DELETE
}

// Tipo de objetivo del feedback
enum FeedbackTargetType {
  BIG_ROCK
  MONTH_PLANNING
}

// ============================================
// MULTI-APP ARCHITECTURE
// ============================================

// Tipos de aplicación disponibles
enum AppType {
  FASE  // Objetivos mensuales Big Rocks
  OKR   // OKRs trimestrales
}

// Periodos trimestrales
enum QuarterPeriod {
  Q1
  Q2
  Q3
  Q4
}

// Estados de OKR Objective
enum OKRObjectiveStatus {
  DRAFT
  ACTIVE
  COMPLETED
  CANCELLED
}

// Estados de OKR Key Result (DEPRECATED - usar actualizaciones semanales)
// Se mantiene por compatibilidad pero no se usa en nuevas funcionalidades
enum OKRKeyResultStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  COMPLETED
}

// Roles de miembros de equipo OKR
enum TeamMemberRole {
  RESPONSABLE   // Crea y edita objetivos, gestiona el equipo
  EDITOR        // Puede editar objetivos existentes
  VISUALIZADOR  // Solo puede ver objetivos (lectura)
  DIRECTOR      // Supervisor del equipo, solo visualiza
}

// ============================================
// MULTI-APP MODELS
// ============================================

// Modelo App (Aplicaciones disponibles)
model App {
  id          String    @id @default(cuid())
  code        AppType   @unique
  name        String
  description String?
  icon        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relaciones
  userApps    UserApp[]
}

// Tabla de unión User-App (M:N permisos de apps por usuario)
model UserApp {
  id        String   @id @default(cuid())
  userId    String
  appId     String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, appId])
  @@index([userId])
  @@index([appId])
}

// ============================================
// COMPANY & ORGANIZATION MODELS
// ============================================

// Modelo Company (Empresa)
model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?  // URL del logo de la empresa
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  userCompanies UserCompany[]
  bigRocks      BigRock[]
  teams         Team[]
  okrQuarters   OKRQuarter[]

  @@index([slug])
}

// Tabla de unión User-Company (M:N)
model UserCompany {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

// ============================================
// OKR TEAM MODELS
// ============================================

// Modelo Team (Equipos para OKRs)
model Team {
  id          String         @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relaciones
  members     TeamMember[]
  objectives  OKRObjective[]

  @@index([companyId])
}

// Miembros del equipo
model TeamMember {
  id        String          @id @default(cuid())
  userId    String
  teamId    String
  role      TeamMemberRole  @default(VISUALIZADOR) // Rol dentro del equipo
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime        @default(now())

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
  @@index([role])
}

// Modelo User
model User {
  id            String      @id @default(uuid())
  email         String      @unique
  name          String?
  image         String?
  role          UserRole    @default(USER)
  status        UserStatus  @default(ACTIVE)  // Estado del usuario
  language      Language    @default(ES)

  // Onboarding tracking
  onboardingCompletedAt DateTime?  // null = no completado, timestamp = completado

  // Chat tracking
  lastVisitedAt DateTime?  // Última visita para calcular cambios nuevos de supervisados

  // Empresa actual seleccionada (para navegación)
  currentCompanyId String?

  // App actual seleccionada (para multi-app)
  currentAppId String?

  // Relación supervisor (1:1)
  supervisorId  String?
  supervisor    User?       @relation("UserSupervisor", fields: [supervisorId], references: [id])
  supervisees   User[]      @relation("UserSupervisor")

  // Relaciones
  companies     UserCompany[]  // Empresas a las que pertenece el usuario
  bigRocks      BigRock[]
  gamification  Gamification?
  openMonths    OpenMonth[]
  activityLogs  ActivityLog[]
  keyPersonFor  BigRockKeyPerson[]  // Big Rocks donde es persona clave

  // Relaciones de feedback
  givenFeedback     Feedback[]  @relation("GivenFeedback")
  receivedFeedback  Feedback[]  @relation("ReceivedFeedback")

  // Relaciones de chat con IA
  chatConversations ChatConversation[]
  chatCredits       UserChatCredits?

  // Relaciones multi-app
  apps              UserApp[]

  // Relaciones OKR
  teamMemberships   TeamMember[]
  ownedObjectives   OKRObjective[]    @relation("OKRObjectiveOwner")
  keyResults        OKRKeyResult[]    @relation("OKRKeyResultResponsible")
  okrActivities     OKRKeyActivity[]  @relation("OKRKeyActivityAssignee")
  okrGamification   OKRGamification?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([email])
  @@index([currentCompanyId])
  @@index([currentAppId])
  @@index([supervisorId])
  @@index([status])
}

// Modelo OpenMonth (Meses futuros abiertos para planificación)
model OpenMonth {
  id                    String    @id @default(uuid())
  month                 String    // Formato: YYYY-MM
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  openedAt              DateTime  @default(now())

  // Confirmación de planificación mensual
  isPlanningConfirmed   Boolean   @default(false)
  planningConfirmedAt   DateTime?

  @@unique([month, userId])
  @@index([userId])
  @@index([month])
}

// Modelo Big Rock (Objetivos Mensuales)
model BigRock {
  id              String         @id @default(uuid())
  title           String
  description     String
  indicator       String         // Métrica para medir el éxito
  numTars         Int            // Número de TAR planificadas
  status          BigRockStatus  @default(CREADO)
  category        FaseCategory?  // Categoria FASE (opcional)

  // Mes al que pertenece (formato: YYYY-MM)
  month           String

  // Evaluación de IA
  aiScore         Int?           // Score de calidad (0-100)
  aiObservations  String?        // Observaciones de la IA
  aiRecommendations String?      // Recomendaciones de mejora
  aiRisks         String?        // Alertas de riesgo

  // Relaciones
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tars            TAR[]
  keyMeetings     KeyMeeting[]
  keyPeople       BigRockKeyPerson[]  // Usuarios como personas clave

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([companyId])
  @@index([month])
  @@index([userId, companyId])
}

// Tabla de unión BigRock-User para Personas Clave
model BigRockKeyPerson {
  id         String   @id @default(uuid())
  bigRockId  String
  bigRock    BigRock  @relation(fields: [bigRockId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       String?  // Rol de la persona en el Big Rock (opcional)
  createdAt  DateTime @default(now())

  @@unique([bigRockId, userId])
  @@index([bigRockId])
  @@index([userId])
}

// Modelo TAR (Tareas de Alto Rendimiento)
model TAR {
  id              String         @id @default(uuid())
  description     String
  status          TarStatus      @default(PENDIENTE)
  progress        Int            @default(0) // Porcentaje de completitud (0-100)

  // Relaciones
  bigRockId       String
  bigRock         BigRock        @relation(fields: [bigRockId], references: [id], onDelete: Cascade)
  activities      Activity[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([bigRockId])
}

// Modelo Activity (Actividades Semanales/Diarias)
model Activity {
  id              String         @id @default(uuid())
  title           String
  description     String?
  type            ActivityType

  // Fecha asociada
  date            DateTime
  week            String?        // Formato: YYYY-WW (número de semana)

  completed       Boolean        @default(false)
  notes           String?        // Notas o aprendizajes

  // Relación
  tarId           String
  tar             TAR            @relation(fields: [tarId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tarId])
  @@index([date])
  @@index([week])
}

// Modelo KeyMeeting (Reuniones Clave)
model KeyMeeting {
  id              String         @id @default(uuid())
  title           String
  description     String?
  date            DateTime
  completed       Boolean        @default(false)
  outcome         String?        // Resultado de la reunión
  objective       String?        // Objetivo de la reunión
  expectedDecision String?       // Decisión esperada

  // Relación
  bigRockId       String
  bigRock         BigRock        @relation(fields: [bigRockId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([bigRockId])
  @@index([date])
}

// Modelo Gamification (Puntos y Medallas)
model Gamification {
  id              String         @id @default(uuid())
  points          Int            @default(0)
  level           Int            @default(1)

  // Rachas
  currentStreak   Int            @default(0) // Días consecutivos
  longestStreak   Int            @default(0)

  // Contadores para medallas
  bigRocksCreated     Int        @default(0)
  tarsCompleted       Int        @default(0)
  weeklyReviews       Int        @default(0)
  dailyLogs           Int        @default(0)

  // Relación (1:1 con User)
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  medals          Medal[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([points])
}

// Modelo Medal (Medallas Obtenidas)
model Medal {
  id              String         @id @default(uuid())
  type            MedalType
  level           MedalLevel

  // Relación
  gamificationId  String
  gamification    Gamification   @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  earnedAt        DateTime       @default(now())

  @@index([gamificationId])
  @@index([type])
  @@index([level])
}

// Modelo ActivityLog (Registro de Actividades del Sistema)
model ActivityLog {
  id          String          @id @default(uuid())
  action      LogActionType
  entityType  LogEntityType
  entityId    String
  description String
  entityTitle String?
  metadata    Json?

  // Relación con usuario
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime        @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// Modelo Feedback (Feedback del supervisor)
model Feedback {
  id              String              @id @default(uuid())
  targetType      FeedbackTargetType
  targetId        String              // BigRock ID o OpenMonth ID
  comment         String              @db.Text
  rating          Int?                // Opcional: 1-5

  // Supervisor que da el feedback
  supervisorId    String
  supervisor      User                @relation("GivenFeedback", fields: [supervisorId], references: [id], onDelete: Cascade)

  // Usuario que recibe el feedback
  userId          String
  user            User                @relation("ReceivedFeedback", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([targetType, targetId])
  @@index([supervisorId])
  @@index([userId])
  @@index([targetType, targetId])
}

// Modelo ChatConversation (Conversaciones con IA)
model ChatConversation {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?       // Título auto-generado del primer mensaje
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  @@index([userId])
  @@index([createdAt])
}

// Modelo ChatMessage (Mensajes de chat)
model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String           // "user" | "assistant" | "system"
  messageType    String           @default("ASSISTANT")  // "USER" | "ASSISTANT" | "SYSTEM"
  content        String           @db.Text
  creditsUsed    Int              @default(0)
  isRead         Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId, isRead])
}

// Modelo UserChatCredits (Créditos diarios de chat)
model UserChatCredits {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditsUsed Int      @default(0)
  lastResetAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ============================================
// OKR MODELS
// ============================================

// Modelo OKRQuarter (Trimestres para OKRs)
model OKRQuarter {
  id         String         @id @default(cuid())
  year       Int
  quarter    QuarterPeriod
  companyId  String
  company    Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  isActive   Boolean        @default(true)
  startDate  DateTime
  endDate    DateTime
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relaciones
  objectives OKRObjective[]

  @@unique([year, quarter, companyId])
  @@index([companyId])
  @@index([year, quarter])
}

// Modelo OKRObjective (Objetivos OKR)
model OKRObjective {
  id          String              @id @default(cuid())
  title       String
  description String?             @db.Text
  indicator   String              // Métrica para medir éxito del objetivo
  status      OKRObjectiveStatus  @default(DRAFT)
  progress    Float               @default(0) // Porcentaje 0-100, calculado de Key Results

  // Relaciones
  quarterId   String
  quarter     OKRQuarter          @relation(fields: [quarterId], references: [id], onDelete: Cascade)
  teamId      String
  team        Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  ownerId     String
  owner       User                @relation("OKRObjectiveOwner", fields: [ownerId], references: [id])

  keyResults  OKRKeyResult[]

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([quarterId])
  @@index([teamId])
  @@index([ownerId])
  @@index([status])
}

// Modelo OKRKeyResult (Resultados Clave)
model OKRKeyResult {
  id            String              @id @default(cuid())
  title         String
  description   String?             @db.Text
  indicator     String              // Descripción de la métrica
  targetValue   Float               // Valor objetivo
  currentValue  Float               @default(0) // Valor actual (se actualiza con cada update semanal)
  startValue    Float               @default(0) // Valor inicial
  unit          String              @default("%") // Unidad de medida (%, €, #, etc.)

  // Relaciones
  objectiveId   String
  objective     OKRObjective        @relation(fields: [objectiveId], references: [id], onDelete: Cascade)
  responsibleId String
  responsible   User                @relation("OKRKeyResultResponsible", fields: [responsibleId], references: [id])

  activities    OKRKeyActivity[]
  updates       OKRKeyResultUpdate[]  // Actualizaciones semanales (historial)

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([objectiveId])
  @@index([responsibleId])
}

// Modelo OKRKeyResultUpdate (Actualizaciones Semanales de Resultados Clave)
model OKRKeyResultUpdate {
  id            String        @id @default(cuid())
  keyResultId   String
  keyResult     OKRKeyResult  @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  weekNumber    Int           // Número de semana del trimestre (1-12)
  previousValue Float         // Valor antes de la actualización
  newValue      Float         // Nuevo valor del indicador
  comment       String        @db.Text  // Comentario sobre el progreso
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([keyResultId, weekNumber])  // Solo una actualización por semana por Key Result
  @@index([keyResultId])
  @@index([weekNumber])
  @@index([createdAt])
}

// Modelo OKRKeyActivity (Actividades para Key Results)
model OKRKeyActivity {
  id          String        @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean       @default(false)
  completedAt DateTime?

  // Relaciones
  keyResultId String
  keyResult   OKRKeyResult  @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  assigneeId  String?
  assignee    User?         @relation("OKRKeyActivityAssignee", fields: [assigneeId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([keyResultId])
  @@index([assigneeId])
  @@index([dueDate])
}

// Modelo OKRGamification (Gamificación específica de OKRs)
model OKRGamification {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  points              Int      @default(0)
  objectivesCreated   Int      @default(0)
  keyResultsCompleted Int      @default(0)
  activitiesCompleted Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([points])
}
