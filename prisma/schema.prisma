// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Roles de usuario: USER, SUPERVISOR, ADMIN, SUPERADMIN
enum UserRole {
  USER
  SUPERVISOR
  ADMIN
  SUPERADMIN
}

// Estados de usuario: INVITED, ACTIVE, DEACTIVATED
enum UserStatus {
  INVITED      // Usuario invitado, pendiente de primer login
  ACTIVE       // Usuario activo
  DEACTIVATED  // Usuario desactivado por el administrador
}

// Idiomas disponibles
enum Language {
  ES  // Castellano
  CA  // Catalan
  EN  // English
}

// Estados de Big Rock (progresión única)
enum BigRockStatus {
  CREADO              // Estado inicial al crear el Big Rock
  CONFIRMADO          // Usuario confirma el Big Rock
  FEEDBACK_RECIBIDO   // Supervisor ha dado feedback
  EN_PROGRESO         // Trabajo en progreso
  FINALIZADO          // Completado
}

// Estados de TAR
enum TarStatus {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
}

// Tipos de actividad
enum ActivityType {
  SEMANAL
  DIARIA
}

// Tipos de medallas
enum MedalType {
  CONSTANCIA
  CLARIDAD
  EJECUCION
  MEJORA_CONTINUA
}

// Niveles de medallas
enum MedalLevel {
  BRONCE
  PLATA
  ORO
  DIAMANTE
}

// Tipos de entidad para Activity Log
enum LogEntityType {
  BIG_ROCK
  TAR
  ACTIVITY
  KEY_PERSON
  KEY_MEETING
}

// Tipos de accion para Activity Log
enum LogActionType {
  CREATE
  UPDATE
  DELETE
}

// Tipo de objetivo del feedback
enum FeedbackTargetType {
  BIG_ROCK
  MONTH_PLANNING
}

// Modelo Company (Empresa)
model Company {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?  // URL del logo de la empresa
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  userCompanies UserCompany[]
  bigRocks      BigRock[]
  keyPeople     KeyPerson[]

  @@index([slug])
}

// Tabla de unión User-Company (M:N)
model UserCompany {
  id        String   @id @default(cuid())
  userId    String
  companyId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

// Modelo User
model User {
  id            String      @id @default(uuid())
  email         String      @unique
  name          String?
  image         String?
  role          UserRole    @default(USER)
  status        UserStatus  @default(ACTIVE)  // Estado del usuario
  language      Language    @default(ES)

  // Onboarding tracking
  onboardingCompletedAt DateTime?  // null = no completado, timestamp = completado

  // Chat tracking
  lastVisitedAt DateTime?  // Última visita para calcular cambios nuevos de supervisados

  // Empresa actual seleccionada (para navegación)
  currentCompanyId String?

  // Relación supervisor (1:1)
  supervisorId  String?
  supervisor    User?       @relation("UserSupervisor", fields: [supervisorId], references: [id])
  supervisees   User[]      @relation("UserSupervisor")

  // Relaciones
  companies     UserCompany[]  // Empresas a las que pertenece el usuario
  bigRocks      BigRock[]
  keyPeople     KeyPerson[]
  gamification  Gamification?
  openMonths    OpenMonth[]
  activityLogs  ActivityLog[]

  // Relaciones de feedback
  givenFeedback     Feedback[]  @relation("GivenFeedback")
  receivedFeedback  Feedback[]  @relation("ReceivedFeedback")

  // Relaciones de chat con IA
  chatConversations ChatConversation[]
  chatCredits       UserChatCredits?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([email])
  @@index([currentCompanyId])
  @@index([supervisorId])
  @@index([status])
}

// Modelo OpenMonth (Meses futuros abiertos para planificación)
model OpenMonth {
  id                    String    @id @default(uuid())
  month                 String    // Formato: YYYY-MM
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  openedAt              DateTime  @default(now())

  // Confirmación de planificación mensual
  isPlanningConfirmed   Boolean   @default(false)
  planningConfirmedAt   DateTime?

  @@unique([month, userId])
  @@index([userId])
  @@index([month])
}

// Modelo Big Rock (Objetivos Mensuales)
model BigRock {
  id              String         @id @default(uuid())
  title           String
  description     String
  indicator       String         // Métrica para medir el éxito
  numTars         Int            // Número de TAR planificadas
  status          BigRockStatus  @default(CREADO)

  // Mes al que pertenece (formato: YYYY-MM)
  month           String

  // Evaluación de IA
  aiScore         Int?           // Score de calidad (0-100)
  aiObservations  String?        // Observaciones de la IA
  aiRecommendations String?      // Recomendaciones de mejora
  aiRisks         String?        // Alertas de riesgo

  // Relaciones
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId       String?
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tars            TAR[]
  keyMeetings     KeyMeeting[]
  keyPeople       KeyPerson[]    // Personas clave asociadas al Big Rock

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([companyId])
  @@index([month])
  @@index([userId, companyId])
}

// Modelo TAR (Tareas de Alto Rendimiento)
model TAR {
  id              String         @id @default(uuid())
  description     String
  status          TarStatus      @default(PENDIENTE)
  progress        Int            @default(0) // Porcentaje de completitud (0-100)

  // Relaciones
  bigRockId       String
  bigRock         BigRock        @relation(fields: [bigRockId], references: [id], onDelete: Cascade)
  activities      Activity[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([bigRockId])
}

// Modelo Activity (Actividades Semanales/Diarias)
model Activity {
  id              String         @id @default(uuid())
  title           String
  description     String?
  type            ActivityType

  // Fecha asociada
  date            DateTime
  week            String?        // Formato: YYYY-WW (número de semana)

  completed       Boolean        @default(false)
  notes           String?        // Notas o aprendizajes

  // Relación
  tarId           String
  tar             TAR            @relation(fields: [tarId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tarId])
  @@index([date])
  @@index([week])
}

// Modelo KeyPerson (Personas Clave)
// Las personas clave son compartidas a nivel de empresa
model KeyPerson {
  id              String         @id @default(uuid())
  firstName       String
  lastName        String
  role            String?        // Rol de la persona
  contact         String?        // Email o teléfono

  // Relaciones
  userId          String         // Usuario que creó la persona clave
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId       String?        // Empresa a la que pertenece (compartida entre usuarios de la empresa)
  company         Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bigRocks        BigRock[]      // Big Rocks asociados a esta persona

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([companyId])
}

// Modelo KeyMeeting (Reuniones Clave)
model KeyMeeting {
  id              String         @id @default(uuid())
  title           String
  description     String?
  date            DateTime
  completed       Boolean        @default(false)
  outcome         String?        // Resultado de la reunión
  objective       String?        // Objetivo de la reunión
  expectedDecision String?       // Decisión esperada

  // Relación
  bigRockId       String
  bigRock         BigRock        @relation(fields: [bigRockId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([bigRockId])
  @@index([date])
}

// Modelo Gamification (Puntos y Medallas)
model Gamification {
  id              String         @id @default(uuid())
  points          Int            @default(0)
  level           Int            @default(1)

  // Rachas
  currentStreak   Int            @default(0) // Días consecutivos
  longestStreak   Int            @default(0)

  // Contadores para medallas
  bigRocksCreated     Int        @default(0)
  tarsCompleted       Int        @default(0)
  weeklyReviews       Int        @default(0)
  dailyLogs           Int        @default(0)

  // Relación (1:1 con User)
  userId          String         @unique
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  medals          Medal[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([points])
}

// Modelo Medal (Medallas Obtenidas)
model Medal {
  id              String         @id @default(uuid())
  type            MedalType
  level           MedalLevel

  // Relación
  gamificationId  String
  gamification    Gamification   @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  earnedAt        DateTime       @default(now())

  @@index([gamificationId])
  @@index([type])
  @@index([level])
}

// Modelo ActivityLog (Registro de Actividades del Sistema)
model ActivityLog {
  id          String          @id @default(uuid())
  action      LogActionType
  entityType  LogEntityType
  entityId    String
  description String
  entityTitle String?
  metadata    Json?

  // Relación con usuario
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime        @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([userId, createdAt])
}

// Modelo Feedback (Feedback del supervisor)
model Feedback {
  id              String              @id @default(uuid())
  targetType      FeedbackTargetType
  targetId        String              // BigRock ID o OpenMonth ID
  comment         String              @db.Text
  rating          Int?                // Opcional: 1-5

  // Supervisor que da el feedback
  supervisorId    String
  supervisor      User                @relation("GivenFeedback", fields: [supervisorId], references: [id], onDelete: Cascade)

  // Usuario que recibe el feedback
  userId          String
  user            User                @relation("ReceivedFeedback", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@unique([targetType, targetId])
  @@index([supervisorId])
  @@index([userId])
  @@index([targetType, targetId])
}

// Modelo ChatConversation (Conversaciones con IA)
model ChatConversation {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String?       // Título auto-generado del primer mensaje
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  @@index([userId])
  @@index([createdAt])
}

// Modelo ChatMessage (Mensajes de chat)
model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String           // "user" | "assistant" | "system"
  messageType    String           @default("ASSISTANT")  // "USER" | "ASSISTANT" | "SYSTEM"
  content        String           @db.Text
  creditsUsed    Int              @default(0)
  isRead         Boolean          @default(false)
  createdAt      DateTime         @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId, isRead])
}

// Modelo UserChatCredits (Créditos diarios de chat)
model UserChatCredits {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditsUsed Int      @default(0)
  lastResetAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}
